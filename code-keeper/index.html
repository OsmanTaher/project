<!doctype html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>حافظة أكواد HTML</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts (Cairo for Arabic & Fira Code for Code) -->
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Fira+Code:wght@400;500&display=swap"
      rel="stylesheet"
    />

    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23f59e0b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><rect x='2' y='3' width='20' height='14' rx='2' ry='2'></rect><line x1='8' y1='21' x2='16' y2='21'></line><line x1='12' y1='17' x2='12' y2='21'></line></svg>"
    />

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- PrismJS for Syntax Highlighting (Optional but makes code look good) -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-html.min.js"></script>

    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              sans: ["Cairo", "sans-serif"],
              mono: ["Fira Code", "monospace"],
            },
            colors: {
              cream: "#FFF7EA",
            },
          },
        },
      };
    </script>

    <style>
      body {
        transition:
          background-color 0.3s,
          color 0.3s;
      }
      /* Custom Scrollbar for Code Blocks */
      pre::-webkit-scrollbar {
        height: 8px;
      }
      pre::-webkit-scrollbar-track {
        background: transparent;
      }
      pre::-webkit-scrollbar-thumb {
        background: #4b5563;
        border-radius: 4px;
      }
      pre::-webkit-scrollbar-thumb:hover {
        background: #6b7280;
      }
    </style>
  </head>
  <body class="bg-cream text-slate-800 min-h-screen font-sans">
    <!-- Header -->
    <header
      id="main-header"
      class="p-6 shadow-sm bg-white/50 transition-colors duration-300 sticky top-0 z-50 backdrop-blur-sm"
    >
      <div class="max-w-6xl mx-auto flex justify-between items-center">
        <div class="flex items-center gap-3">
          <div
            class="p-2 rounded-lg bg-orange-100 text-orange-600 dark:bg-slate-700 dark:text-orange-400"
          >
            <i data-lucide="code-2" class="w-8 h-8"></i>
          </div>
          <div>
            <h1 class="text-2xl font-bold tracking-tight">مكتبة الأكواد</h1>
            <p class="text-xs opacity-70">احفظ مقتطفات HTML الخاصة بك</p>
          </div>
        </div>
        <button
          id="theme-toggle"
          class="p-2 rounded-full transition-all bg-amber-100 hover:bg-amber-200 text-amber-600"
          title="تغيير المظهر"
        >
          <i data-lucide="moon" class="w-5 h-5"></i>
        </button>
      </div>
    </header>

    <main class="w-full p-4 md:p-8 flex flex-col items-center gap-10">
      <!-- Add New Snippet Form Container (Width 100%) -->
      <div class="w-full space-y-6">
        <div
          id="form-card"
          class="p-6 rounded-2xl border-2 shadow-lg transition-all bg-white border-slate-900"
        >
          <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
            <i data-lucide="plus-circle" class="w-5 h-5 text-indigo-500"></i>
            إضافة كود جديد
          </h2>

          <form id="add-code-form" class="space-y-4">
            <!-- Title Input -->
            <div class="space-y-1">
              <label class="text-sm font-semibold opacity-80"
                >عنوان الكود</label
              >
              <input
                type="text"
                id="code-title"
                placeholder="مثلاً: زر تسجيل دخول"
                class="w-full p-3 rounded-xl border-2 outline-none transition-colors bg-gray-50 border-gray-200 focus:border-indigo-500 text-slate-800"
              />
              <!-- Error Message -->
              <span
                id="title-error"
                class="hidden text-red-500 text-xs font-bold mt-1 block"
                >هذا الحقل مطلوب *</span
              >
            </div>

            <!-- Code Textarea -->
            <div class="space-y-1">
              <label class="text-sm font-semibold opacity-80"
                >الكود (HTML)</label
              >
              <textarea
                id="code-content"
                rows="8"
                placeholder="<div>...</div>"
                class="w-full p-3 rounded-xl border-2 outline-none transition-colors font-mono text-sm bg-gray-900 border-gray-700 focus:border-indigo-500 text-green-400 placeholder-gray-600 resize-none"
                dir="ltr"
              ></textarea>
            </div>

            <button
              type="submit"
              id="save-btn"
              class="w-full py-3 px-4 rounded-xl font-bold text-white shadow-md transform active:scale-95 transition-all bg-indigo-600 hover:bg-indigo-700 flex justify-center items-center gap-2"
            >
              <i data-lucide="save" class="w-5 h-5"></i>
              حفظ الكود
            </button>
          </form>
        </div>
      </div>

      <!-- Saved Snippets List Container (Width 100%) -->
      <div class="w-full space-y-6">
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-bold flex items-center gap-2">
            <span
              id="list-indicator"
              class="w-3 h-8 rounded-full bg-orange-500 transition-colors"
            ></span>
            المحفوظات (<span id="snippets-count">0</span>)
          </h2>

          <!-- Search Box -->
          <div class="relative hidden md:block">
            <input
              type="text"
              id="search-input"
              placeholder="بحث..."
              class="pl-3 pr-9 py-1.5 rounded-lg border bg-transparent text-sm focus:outline-none focus:border-indigo-500 transition-colors w-48"
            />
            <i
              data-lucide="search"
              class="w-4 h-4 absolute right-3 top-2.5 opacity-50"
            ></i>
          </div>
        </div>

        <!-- List Container -->
        <div id="snippets-list" class="space-y-4">
          <!-- Cards will be injected here -->
        </div>

        <!-- Empty State -->
        <div
          id="empty-state"
          class="hidden flex flex-col items-center justify-center text-center opacity-50 py-20 border-2 border-dashed rounded-2xl border-slate-300 dark:border-slate-700"
        >
          <div class="p-4 rounded-full bg-slate-200 dark:bg-slate-800 mb-4">
            <i data-lucide="layers" class="w-10 h-10"></i>
          </div>
          <h3 class="text-lg font-bold">المكتبة فارغة</h3>
          <p class="text-sm max-w-xs mt-2">
            ابدأ بإضافة أكوادك المفضلة في النموذج أعلاه لتظهر هنا.
          </p>
        </div>
      </div>
    </main>

    <!-- Toast Notification -->
    <div
      id="toast"
      class="fixed bottom-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full bg-slate-800 text-white shadow-xl translate-y-20 opacity-0 transition-all duration-300 z-50 flex items-center gap-2"
    >
      <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
      <span id="toast-msg">تم الحفظ بنجاح</span>
    </div>

    <!-- JavaScript Logic -->
    <script>
      // --- State Management ---
      // Start Empty as requested: || []
      let snippets = JSON.parse(localStorage.getItem("htmlSnippets")) || [];
      let isDarkMode = localStorage.getItem("theme_code") === "dark";

      // --- DOM Elements ---
      const body = document.body;
      const themeToggleBtn = document.getElementById("theme-toggle");
      const form = document.getElementById("add-code-form");
      const titleInput = document.getElementById("code-title");
      const titleError = document.getElementById("title-error"); // New
      const contentInput = document.getElementById("code-content");
      const listContainer = document.getElementById("snippets-list");
      const emptyState = document.getElementById("empty-state");
      const countSpan = document.getElementById("snippets-count");
      const searchInput = document.getElementById("search-input");

      // Style Elements
      const header = document.getElementById("main-header");
      const formCard = document.getElementById("form-card");
      const listIndicator = document.getElementById("list-indicator");

      // --- Initialization ---
      function init() {
        applyTheme();
        renderSnippets();
      }

      // --- Theme Logic ---
      function applyTheme() {
        if (isDarkMode) {
          body.className = "bg-slate-900 text-white min-h-screen font-sans";
          header.classList.replace("bg-white/50", "bg-slate-800/90");

          themeToggleBtn.innerHTML =
            '<i data-lucide="sun" class="w-5 h-5"></i>';
          themeToggleBtn.className =
            "p-2 rounded-full transition-all bg-slate-700 text-yellow-400 hover:bg-slate-600";

          formCard.className =
            "p-6 rounded-2xl border-2 shadow-lg transition-all bg-slate-800 border-slate-700";

          titleInput.className =
            "w-full p-3 rounded-xl border-2 outline-none transition-colors bg-slate-700 border-slate-600 focus:border-indigo-500 text-white placeholder-slate-400";

          listIndicator.className =
            "w-3 h-8 rounded-full bg-indigo-500 transition-colors";
        } else {
          body.className = "bg-cream text-slate-800 min-h-screen font-sans";
          header.classList.replace("bg-slate-800/90", "bg-white/50");

          themeToggleBtn.innerHTML =
            '<i data-lucide="moon" class="w-5 h-5"></i>';
          themeToggleBtn.className =
            "p-2 rounded-full transition-all bg-amber-100 text-amber-600 hover:bg-amber-200";

          formCard.className =
            "p-6 rounded-2xl border-2 shadow-lg transition-all bg-white border-slate-900";

          titleInput.className =
            "w-full p-3 rounded-xl border-2 outline-none transition-colors bg-gray-50 border-gray-200 focus:border-indigo-500 text-slate-800";

          listIndicator.className =
            "w-3 h-8 rounded-full bg-orange-500 transition-colors";
        }
        localStorage.setItem("theme_code", isDarkMode ? "dark" : "light");
        renderSnippets(); // Re-render to update card styles
        lucide.createIcons();
      }

      themeToggleBtn.addEventListener("click", () => {
        isDarkMode = !isDarkMode;
        applyTheme();
      });

      // --- CRUD Operations ---

      function saveToLocal() {
        localStorage.setItem("htmlSnippets", JSON.stringify(snippets));
        renderSnippets();
      }

      // Remove error when typing
      titleInput.addEventListener("input", () => {
        if (titleInput.value.trim() !== "") {
          titleInput.classList.remove("border-red-500");
          titleError.classList.add("hidden");

          // Restore original border based on theme
          if (isDarkMode) {
            titleInput.classList.add("border-slate-600");
          } else {
            titleInput.classList.add("border-gray-200");
          }
        }
      });

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const title = titleInput.value.trim();
        const code = contentInput.value;

        // Validation Logic
        let hasError = false;

        if (!title) {
          // Remove default neutral borders to ensure red is visible
          titleInput.classList.remove("border-gray-200", "border-slate-600");
          titleInput.classList.add("border-red-500");
          titleError.classList.remove("hidden");
          hasError = true;
        }

        if (hasError) return;

        // If valid, proceed
        if (!code) {
          showToast("يرجى كتابة الكود", true);
          return;
        }

        const newSnippet = {
          id: Date.now(),
          title: title,
          code: code,
          date: new Date().toLocaleDateString("ar-EG"),
          expanded: false, // Initial state
        };

        snippets.unshift(newSnippet); // Add to top
        saveToLocal();

        // Reset Form
        titleInput.value = "";
        contentInput.value = "";

        // Reset borders just in case
        if (isDarkMode) {
          titleInput.classList.add("border-slate-600");
        } else {
          titleInput.classList.add("border-gray-200");
        }
        titleInput.classList.remove("border-red-500");
        titleError.classList.add("hidden");

        showToast("تم حفظ الكود بنجاح");
      });

      function deleteSnippet(id) {
        if (confirm("هل أنت متأكد من حذف هذا الكود؟")) {
          snippets = snippets.filter((s) => s.id !== id);
          saveToLocal();
          showToast("تم الحذف", true);
        }
      }

      function toggleExpand(id) {
        // Toggle specific card
        snippets = snippets.map((s) =>
          s.id === id ? { ...s, expanded: !s.expanded } : s,
        );
        saveToLocal();
      }

      function copyCode(id) {
        const snippet = snippets.find((s) => s.id === id);
        if (snippet) {
          navigator.clipboard.writeText(snippet.code).then(() => {
            showToast("تم نسخ الكود");
          });
        }
      }

      // --- Preview Logic (New) ---
      function previewCode(id) {
        const snippet = snippets.find((s) => s.id === id);
        if (snippet) {
          // Open new window
          const newWindow = window.open("", "_blank");
          if (newWindow) {
            newWindow.document.write(snippet.code);
            newWindow.document.close(); // Essential for some browsers to stop loading
          } else {
            showToast("تم حظر النوافذ المنبثقة", true);
          }
        }
      }

      // --- Search ---
      searchInput.addEventListener("input", (e) => {
        renderSnippets(e.target.value.toLowerCase());
      });

      // --- Rendering ---
      function renderSnippets(searchTerm = "") {
        const filtered = snippets.filter((s) =>
          s.title.toLowerCase().includes(searchTerm),
        );
        countSpan.textContent = filtered.length;

        if (filtered.length === 0) {
          listContainer.innerHTML = "";
          emptyState.classList.remove("hidden");
        } else {
          emptyState.classList.add("hidden");

          listContainer.innerHTML = filtered
            .map((snippet) => {
              const cardBg = isDarkMode
                ? "bg-slate-800 border-slate-700"
                : "bg-white border-slate-200";
              const iconColor = isDarkMode
                ? "text-indigo-400"
                : "text-orange-500";
              const hoverBg = isDarkMode
                ? "hover:bg-slate-700"
                : "hover:bg-slate-50";

              return `
                    <div class="rounded-xl border ${cardBg} overflow-hidden shadow-sm transition-all duration-300">
                        <!-- Card Header -->
                        <div class="p-4 flex items-center justify-between cursor-pointer ${hoverBg}" onclick="toggleExpand(${snippet.id})">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <div class="p-2 rounded-lg bg-opacity-10 ${isDarkMode ? "bg-indigo-500" : "bg-orange-500"}">
                                    <i data-lucide="code" class="w-5 h-5 ${iconColor}"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg truncate">${escapeHtml(snippet.title)}</h3>
                                    <span class="text-xs opacity-50">${snippet.date}</span>
                                </div>
                            </div>
                            
                            <!-- Actions: Preview & Expand -->
                            <div class="flex items-center gap-3">
                                <!-- Preview Button -->
                                <button onclick="event.stopPropagation(); previewCode(${snippet.id})" class="p-2 rounded-full hover:bg-indigo-100 dark:hover:bg-slate-600 text-indigo-500 dark:text-indigo-400 transition-colors" title="معاينة النتيجة">
                                    <i data-lucide="eye" class="w-5 h-5"></i>
                                </button>
                                
                                <!-- Divider -->
                                <div class="h-4 w-px bg-slate-300 dark:bg-slate-600"></div>

                                <!-- Arrow -->
                                <div class="transform transition-transform duration-300 ${snippet.expanded ? "rotate-180" : ""}">
                                    <i data-lucide="chevron-down" class="w-5 h-5 opacity-50"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Card Body (Code) -->
                        <div class="${snippet.expanded ? "block" : "hidden"} border-t ${isDarkMode ? "border-slate-700 bg-slate-900/50" : "border-slate-100 bg-gray-50"}">
                            <div class="p-2 flex justify-end gap-2 border-b ${isDarkMode ? "border-slate-700" : "border-gray-200"} px-4 py-2">
                                <button onclick="event.stopPropagation(); copyCode(${snippet.id})" class="text-xs flex items-center gap-1 px-3 py-1.5 rounded-md hover:bg-indigo-100 dark:hover:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 transition-colors font-medium">
                                    <i data-lucide="copy" class="w-3 h-3"></i> نسخ
                                </button>
                                <button onclick="event.stopPropagation(); deleteSnippet(${snippet.id})" class="text-xs flex items-center gap-1 px-3 py-1.5 rounded-md hover:bg-red-100 dark:hover:bg-red-900/30 text-red-500 transition-colors font-medium">
                                    <i data-lucide="trash-2" class="w-3 h-3"></i> حذف
                                </button>
                            </div>
                            <div class="relative group">
                                <pre class="p-4 overflow-x-auto text-sm font-mono language-html" dir="ltr"><code class="language-html">${escapeHtml(snippet.code)}</code></pre>
                            </div>
                        </div>
                    </div>
                    `;
            })
            .join("");

          // Re-run Prism highlighting
          if (window.Prism) {
            Prism.highlightAll();
          }
        }
        lucide.createIcons();
      }

      // --- Utilities ---
      function showToast(message, isError = false) {
        const toast = document.getElementById("toast");
        const msgSpan = document.getElementById("toast-msg");

        msgSpan.textContent = message;
        toast
          .querySelector("i")
          .setAttribute(
            "data-lucide",
            isError ? "alert-circle" : "check-circle",
          );
        toast
          .querySelector("i")
          .classList.remove("text-green-400", "text-red-400");
        toast
          .querySelector("i")
          .classList.add(isError ? "text-red-400" : "text-green-400");

        lucide.createIcons();

        toast.classList.remove("translate-y-20", "opacity-0");
        setTimeout(() => {
          toast.classList.add("translate-y-20", "opacity-0");
        }, 3000);
      }

      function escapeHtml(text) {
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      // Start App
      init();
    </script>
  </body>
</html>
